<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Seat Selection - BuyTicket</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-brown: #5D4037;
                --light-brown: #8D6E63;
                --orange: #FF6F00;
                --light-orange: #FF8F00;
                --yellow: #FFC107;
                --light-yellow: #FFD54F;
                --white: #FFFFFF;
                --cream: #FFF8E1;
                --text-dark: #3E2723;
                --green: #4CAF50;
                --red: #F44336;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, var(--cream) 0%, var(--light-yellow) 100%);
                min-height: 100vh;
                color: var(--text-dark);
            }

            /*header*/
            header {
                background:linear-gradient(135deg, var(--primary-brown) 0%, var(--light-brown) 100%);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

            nav {
                max-width: 1200px;
                margin: 0 auto;
                padding: 1rem 2rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .logo {
                font-size: 1.8rem;
                font-weight: bold;
                color: var(--white);
                text-decoration: none;
            }

            .user-info {
                display: flex;
                align-items: center;
                gap: 1rem;
                color: var(--white);
            }

            .credit-badge {
                background: var(--orange);
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-weight: 600;
            }

            /*container*/
            .container {
                max-width: 1200px;
                margin: 2rem auto;
                padding: 0 2rem;
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }

            /*service info*/
            .service-info {
                background: var(--white);
                padding: 1.5rem;
                border-radius: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                margin-bottom: 1.5rem;
            }

            .service-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid var(--cream);
            }

            .service-time {
                display: flex;
                gap: 1rem;
                align-items: center;
            }

            .departure-time, .arrival-time {
                font-size: 1.2rem;
                font-weight: bold;
                color: var(--primary-brown);
                padding: 0.5rem 1rem;
                background: var(--cream);
                border-radius: 8px;
            }

            .service-details-small {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 2rem;
            }

            .route {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .route-time {
                font-size: 1.4rem;
                font-weight: bold;
                color: var(--primary-brown);
                margin-bottom: 0.2rem;
            }

            .route-arrow {
                color: var(--orange);
                font-size: 1.5rem;
            }

            /*seat selection */
            .seat-selection {
                background: var(--white);
                padding: 2rem;
                border-radius: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }

            .seat-selection h3 {
                color: var(--primary-brown);
                margin-bottom: 1.5rem;
                text-align: center;
            }

            .bus-layout {
                background: var(--cream);
                padding: 2rem;
                border-radius: 15px;
                margin-bottom: 2rem;
            }

            .driver-section {
                text-align: right;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px dashed var(--light-brown);
            }

            .driver-icon {
                display: inline-block;
                font-size: 2rem;
                background: var(--primary-brown);
                color: var(--white);
                padding: 0.5rem 1rem;
                border-radius: 10px;
            }

            .seats-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 1rem;
                max-width: 300px;
                margin: 0 auto;
            }

            .seat {
                aspect-ratio: 1;
                border: 2px solid var(--light-brown);
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                background: var(--white);
                position: relative;
            }

            .seat:hover:not(.occupied):not(.selected) {
                transform: scale(1.05);
                border-color: var(--orange);
            }

            .seat.occupied {
                background: var(--red);
                color: var(--white);
                cursor: not-allowed;
                opacity: 0.6;
            }

            .seat.selected {
                background: var(--green);
                color: var(--white);
                border-color: var(--green);
                transform: scale(1.05);
            }

            .seat.aisle {
                background: transparent;
                border: none;
                cursor: default;
            }

            /*legend*/
            .seat-legend {
                display: flex;
                justify-content: center;
                gap: 2rem;
                margin-top: 2rem;
                flex-wrap: wrap;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .legend-box {
                width: 30px;
                height: 30px;
                border-radius: 5px;
                border: 2px solid var(--light-brown);
            }

            .legend-box.available {
                background: var(--white);
            }

            .legend-box.occupied {
                background: var(--red);
                border-color: var(--red);
            }

            .legend-box.selected {
                background: var(--green);
                border-color: var(--green);
            }

            /*summary panel*/
            .summary-panel {
                background: var(--white);
                padding: 2rem;
                border-radius: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                height: fit-content;
                position: sticky;
                top: 2rem;
            }

            .summary-panel h3 {
                color: var(--primary-brown);
                margin-bottom: 1.5rem;
            }

            .selected-seats {
                margin-bottom: 1.5rem;
                padding-bottom: 1.5rem;
                border-bottom: 2px solid var(--cream);
            }

            .selected-seat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                background: var(--cream);
                border-radius: 8px;
            }

            .remove-seat {
                background: var(--red);
                color: var(--white);
                border: none;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1rem;
            }

            .price-breakdown {
                margin-bottom: 1.5rem;
            }

            .price-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.8rem;
                color: var(--light-brown);
            }

            .price-row.total {
                font-size: 1.3rem;
                font-weight: bold;
                color: var(--primary-brown);
                padding-top: 1rem;
                border-top: 2px solid var(--cream);
            }

            .coupon-section {
                margin-bottom: 1.5rem;
            }

            .coupon-input-group {
                display: flex;
                gap: 0.5rem;
            }

            .coupon-input-group input {
                flex: 1;
                padding: 0.7rem;
                border: 2px solid var(--cream);
                border-radius: 8px;
                font-size: 1rem;
                transition: border-color 0.3s;
            }

            .coupon-input-group input:focus {
                outline: none;
                border-color: var(--orange);
            }

            .coupon-input-group input:disabled {
                background: var(--cream);
                color: var(--light-brown);
                cursor: not-allowed;
            }

            .btn-apply-coupon:disabled {
                background: var(--light-brown);
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-apply-coupon {
                background: var(--light-brown);
                color: var(--white);
                border: none;
                padding: 0.7rem 1rem;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
            }

            .btn-apply-coupon:hover {
                background: var(--primary-brown);
            }

            .discount-applied {
                padding: 0.5rem 1rem;
                border-radius: 5px;
                margin-top: 0.5rem;
                font-size: 0.9rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }

            .discount-applied.success {
                background: var(--green);
                color: var(--white);
            }

            .discount-applied.error {
                background: var(--red);
                color: var(--white);
            }


            .btn-purchase {
                width: 100%;
                padding: 1rem;
                background: linear-gradient(135deg, var(--orange) 0%, var(--light-orange) 100% );
                color: var(--white);
                border: none;
                border-radius: 10px;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-purchase:hover:not(:disabled) {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .info-message {
                background: var(--cream);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                font-size: 0.9rem;
                color: var(--light-brown);
            }

            @media (max-width: 968px) {
                .container {
                    grid-template-columns: 1fr;
                }

                .summary-panel {
                    position: static;
                }
            }
        </style>

    </head>
    <body>
        <header>
            <nav>
                <a href="index.html" class="logo">ðŸšŒ BuyTicket</a>
                <div class="user-info">
                    <span>Ahmet YÄ±lmaz</span>
                    <div class="credit-badge">ðŸ’³ 1,500 TL</div>
                </div>
            </nav>
        </header>

        <div class="container">
            <div>
                <div class="service-info">
                    <div class="service-header">
                        <h3>Metro Tourism</h3>
                        <div class="service-time">
                            <div class="departure-time">09:00</div>
                            <div class="arrival-time">14:30</div>
                        </div>
                    </div>
                    <div class="service-details-small">
                        <div class="route">
                            <div>
                                <div>Istanbul</div>
                            </div>
                            <div class="route-arrow">â†’</div>
                            <div>
                                <div>Ankara</div>
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: bold; color: var(--orange);">350 TL</div>
                            <div style="font-size: 0.9rem; color: var(--light-brown);">15 October 2025</div>
                        </div>
                    </div>
                </div>

                <div class="seat-selection">
                    <h3>Seat Selection</h3>

                    <div class="driver-section">
                        <div class="driver-icon">ðŸš—</div>
                    </div>

                    <div class="seats-grid">
                        <!--Row 1-->
                        <div class="seat" data-seat="1">1</div>
                        <div class="seat" data-seat="2">2</div>
                        <div class="seat aisle"></div>
                        <div class="seat occupied" data-seat="3">3</div>

                        <!-- Row 2 -->
                        <div class="seat" data-seat="4">4</div>
                        <div class="seat occupied" data-seat="5">5</div>
                        <div class="seat aisle"></div>
                        <div class="seat" data-seat="6">6</div>

                        <!-- Row 3 -->
                        <div class="seat" data-seat="7">7</div>
                        <div class="seat" data-seat="8">8</div>
                        <div class="seat aisle"></div>
                        <div class="seat occupied" data-seat="9">9</div>

                        <!-- Row 4 -->
                        <div class="seat" data-seat="10">10</div>
                        <div class="seat" data-seat="11">11</div>
                        <div class="seat aisle"></div>
                        <div class="seat" data-seat="12">12</div>

                        <!-- Row 5 -->
                        <div class="seat occupied" data-seat="13">13</div>
                        <div class="seat" data-seat="14">14</div>
                        <div class="seat aisle"></div>
                        <div class="seat" data-seat="15">15</div>

                        <!-- Row 6 -->
                        <div class="seat" data-seat="16">16</div>
                        <div class="seat" data-seat="17">17</div>
                        <div class="seat aisle"></div>
                        <div class="seat occupied" data-seat="18">18</div>

                        <!-- Row 7 -->
                        <div class="seat" data-seat="19">19</div>
                        <div class="seat" data-seat="20">20</div>
                        <div class="seat aisle"></div>
                        <div class="seat" data-seat="21">21</div>

                        <!-- Row 8 -->
                        <div class="seat" data-seat="22">22</div>
                        <div class="seat" data-seat="23">23</div>
                        <div class="seat aisle"></div>
                        <div class="seat" data-seat="24">24</div>
                    </div>
                </div>

                <div class="seat-legend">
                    <div class="legend-item">
                        <div class="legend-box available"></div>
                        <span>Empty</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box occupied"></div>
                        <span>Full</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box selected"></div>
                        <span>Selected</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="summary-panel">
        <h3>Summary</h3>

        <div class="info-message">
            You can select up to 5 seats.
        </div>

        <div class="selected-seats">
            <h4 style="margin-bottom: 1rem; color: var(--light-brown);">Selected Seats</h4>
            <div id="selected-seats-list">
                <p style="color: var(--light-brown); font-size: 0.9rem;">No seats selected yet</p>
            </div>
        </div>

        <div class="price-breakdown">
            <div class="price-now">
                <span>Ticket Price:</span>
                <span id="base-price">350 TL</span>
            </div>
            <div class="price-row">
                <span>Number of seats:</span>
                <span id="seat-count">0</span>
            </div>
            <div class="price-row">
                <span>Subtotal:</span>
                <span id="subtotal">0 TL</span>
            </div>
            <div class="price-row" id="discount-row" style="display: none; color: var(--green);">
                <span>Discount:</span>
                <span id="discount-amount">0 TL</span>
            </div>
            <div class="price-row total">
                <span>Total:</span>
                <span id="total-price">0 TL</span>
            </div>
        </div>

        <div class="coupon-section">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--primary-brown); font-weight: 600;">Discount Coupon:</label>
            <div class="coupon-input-group">
                <input type="text" id="coupon-input" placeholder="Enter your coupon code">
                <button type="button" class="btn-apply-coupon">Apply</button>
            </div>
            <div class="discount-applied" id="discount-message" style="display: none;">
                Coupon applied successfully!
            </div>
        </div>

        <button class="btn-purchase" id="purchase-btn" disabled>Make payment</button>

        <div class="info-message" style="margin-top: 1rem;">
            Your current credit: 1500 TL
        </div>
    </div>
</div>

<script>
    // ===== API CONFIGURATION =====
    const API_URL = 'http://localhost:5000/api';
    
    // ===== STATE =====
    let tripData = null;
    let seatsData = [];
    let selectedSeats = []; // {seatId, seatNumber}
    let discountRate = 0;
    let appliedCouponCode = '';
    let userCredit = 0;
    let seatPrice = 350;

    // ===== CHECK LOGIN =====
    function checkLogin() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (!isLoggedIn) {
            alert('Please login to book tickets.');
            window.location.href = 'login.html';
            return false;
        }
        return true;
    }

    // ===== LOAD TRIP DATA =====
    async function loadTripData() {
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get('trip');
        
        // Try from localStorage first
        const savedTrip = localStorage.getItem('selectedTrip');
        if (savedTrip) {
            tripData = JSON.parse(savedTrip);
            seatPrice = tripData.Price || 350;
            updateTripDisplay();
        }
        
        if (tripId) {
            try {
                const response = await fetch(`${API_URL}/trips/${tripId}`, {credentials: 'include'});
                const data = await response.json();
                if (data.success) {
                    tripData = data.trip;
                    seatPrice = tripData.Price || 350;
                    updateTripDisplay();
                    loadSeats(tripId);
                }
            } catch (error) {
                console.error('Error loading trip:', error);
            }
        }
    }

    // ===== UPDATE TRIP DISPLAY =====
    function updateTripDisplay() {
        if (!tripData) return;
        
        const companyName = document.querySelector('.service-header h3');
        if (companyName) companyName.textContent = tripData.CompanyName || 'Metro Turizm';
        
        const departureTime = document.querySelector('.departure-time');
        if (departureTime) departureTime.textContent = (tripData.DepartureTime || '').substring(0, 5);
        
        const arrivalTime = document.querySelector('.arrival-time');
        if (arrivalTime) arrivalTime.textContent = (tripData.ArrivalTime || '').substring(0, 5);
        
        const routeDivs = document.querySelectorAll('.route > div');
        if (routeDivs.length >= 3) {
            routeDivs[0].innerHTML = `<div>${tripData.DepartureCity || 'Istanbul'}</div>`;
            routeDivs[2].innerHTML = `<div>${tripData.ArrivalCity || 'Ankara'}</div>`;
        }
        
        const priceEl = document.querySelector('.service-details-small div:last-child div:first-child');
        if (priceEl) priceEl.textContent = `${tripData.Price || 350} TL`;
        
        document.getElementById('base-price').textContent = `${seatPrice} TL`;
    }

    // ===== LOAD USER DATA =====
    function loadUserData() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        userCredit = user.credit_balance || 0;
        
        const userInfo = document.querySelector('.user-info');
        if (userInfo) {
            userInfo.innerHTML = `
                <span>${user.first_name || 'User'} ${user.last_name || ''}</span>
                <div class="credit-badge">ðŸ’³ ${userCredit.toLocaleString()} TL</div>
            `;
        }
        
        const creditInfo = document.querySelector('.info-message:last-child');
        if (creditInfo) {
            creditInfo.textContent = `Your current credit: ${userCredit.toLocaleString()} TL`;
        }
    }

    // ===== LOAD SEATS FROM API =====
    async function loadSeats(tripId) {
        try {
            const response = await fetch(`${API_URL}/trips/${tripId}/seats`, {credentials: 'include'});
            const data = await response.json();
            
            if (data.success) {
                seatsData = data.seats;
                renderSeats();
            }
        } catch (error) {
            console.error('Error loading seats:', error);
        }
    }

    // ===== RENDER SEATS =====
    function renderSeats() {
        const seatsGrid = document.querySelector('.seats-grid');
        if (!seatsGrid || seatsData.length === 0) return;
        
        seatsGrid.innerHTML = '';
        
        // Group by row
        const rows = {};
        seatsData.forEach(seat => {
            if (!rows[seat.SeatRow]) rows[seat.SeatRow] = [];
            rows[seat.SeatRow].push(seat);
        });
        
        // Render each row
        Object.keys(rows).sort((a, b) => a - b).forEach(row => {
            const rowSeats = rows[row].sort((a, b) => a.SeatColumn.localeCompare(b.SeatColumn));
            
            // A, B seats (left)
            rowSeats.filter(s => ['A', 'B'].includes(s.SeatColumn)).forEach(seat => {
                seatsGrid.appendChild(createSeatElement(seat));
            });
            
            // Aisle
            const aisle = document.createElement('div');
            aisle.className = 'seat aisle';
            seatsGrid.appendChild(aisle);
            
            // C, D seats (right)
            rowSeats.filter(s => ['C', 'D'].includes(s.SeatColumn)).forEach(seat => {
                seatsGrid.appendChild(createSeatElement(seat));
            });
        });
    }

    function createSeatElement(seat) {
        const div = document.createElement('div');
        div.className = 'seat';
        div.dataset.seatId = seat.SeatID;
        div.dataset.seatNumber = seat.SeatNumber;
        div.textContent = seat.SeatNumber;
        
        if (seat.SeatStatus === 'Occupied') {
            div.classList.add('occupied');
        } else {
            div.addEventListener('click', () => toggleSeat(div, seat));
        }
        
        return div;
    }

    // ===== TOGGLE SEAT SELECTION =====
    function toggleSeat(element, seat) {
        const index = selectedSeats.findIndex(s => s.seatId === seat.SeatID);
        
        if (index > -1) {
            selectedSeats.splice(index, 1);
            element.classList.remove('selected');
        } else {
            if (selectedSeats.length >= 5) {
                alert('You can select up to 5 seats!');
                return;
            }
            selectedSeats.push({seatId: seat.SeatID, seatNumber: seat.SeatNumber});
            element.classList.add('selected');
        }
        
        updateSummary();
    }

    // ===== UPDATE SUMMARY =====
    function updateSummary() {
        const seatsList = document.getElementById('selected-seats-list');
        const purchaseBtn = document.getElementById('purchase-btn');
        
        if (selectedSeats.length === 0) {
            seatsList.innerHTML = '<p style="color: var(--light-brown); font-size: 0.9rem;">No seats selected yet</p>';
            purchaseBtn.disabled = true;
        } else {
            seatsList.innerHTML = selectedSeats.map(s => `
                <div class="selected-seat-item">
                    <span>Seat ${s.seatNumber}</span>
                    <span>${seatPrice} TL</span>
                </div>
            `).join('');
            purchaseBtn.disabled = false;
        }
        
        // Update pricing
        const subtotal = selectedSeats.length * seatPrice;
        const discount = subtotal * (discountRate / 100);
        const total = subtotal - discount;
        
        document.getElementById('seat-count').textContent = selectedSeats.length;
        document.getElementById('subtotal').textContent = `${subtotal} TL`;
        document.getElementById('total-price').textContent = `${total} TL`;
        
        if (discountRate > 0) {
            document.getElementById('discount-row').style.display = 'flex';
            document.getElementById('discount-amount').textContent = `-${discount} TL`;
        }
        
        // Update coupon section
        const couponInput = document.getElementById('coupon-input');
        const couponBtn = document.querySelector('.btn-apply-coupon');
        if (selectedSeats.length === 0 || discountRate > 0) {
            couponInput.disabled = true;
            couponBtn.disabled = true;
        } else {
            couponInput.disabled = false;
            couponBtn.disabled = false;
        }
    }

    // ===== VALIDATE COUPON =====
    async function validateCoupon() {
        const couponCode = document.getElementById('coupon-input').value.trim();
        
        if (!couponCode) {
            showCouponMessage('Please enter a coupon code.', 'error');
            return;
        }
        
        if (selectedSeats.length === 0) {
            showCouponMessage('Please select at least one seat first.', 'error');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/coupons/validate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({coupon_code: couponCode})
            });
            
            const data = await response.json();
            
            if (data.valid) {
                discountRate = data.discount_rate;
                appliedCouponCode = couponCode;
                showCouponMessage(`Coupon applied! ${discountRate}% discount.`, 'success');
                document.getElementById('coupon-input').disabled = true;
                document.querySelector('.btn-apply-coupon').disabled = true;
                updateSummary();
            } else {
                showCouponMessage(data.message || 'Invalid coupon.', 'error');
            }
        } catch (error) {
            console.error('Coupon validation error:', error);
            showCouponMessage('Error validating coupon.', 'error');
        }
    }

    function showCouponMessage(message, type) {
        const el = document.getElementById('discount-message');
        el.textContent = message;
        el.className = `discount-applied ${type}`;
        el.style.display = 'flex';
        
        if (type === 'error') {
            setTimeout(() => el.style.display = 'none', 3000);
        }
    }

    // ===== PURCHASE TICKET =====
    async function purchaseTicket() {
        if (selectedSeats.length === 0) return;
        
        const subtotal = selectedSeats.length * seatPrice;
        const discount = subtotal * (discountRate / 100);
        const total = subtotal - discount;
        
        if (total > userCredit) {
            alert(`Insufficient balance. You need ${total} TL but have ${userCredit} TL.`);
            return;
        }
        
        if (!confirm(`Purchase ${selectedSeats.length} seat(s) for ${total} TL?`)) {
            return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const passengerNames = selectedSeats.map(() => `${user.first_name} ${user.last_name}`);
        
        const btn = document.getElementById('purchase-btn');
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        try {
            const response = await fetch(`${API_URL}/tickets/purchase`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    trip_id: tripData.TripID,
                    seat_ids: selectedSeats.map(s => s.seatId),
                    passenger_names: passengerNames,
                    coupon_code: appliedCouponCode || null
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update local storage with new balance
                user.credit_balance = data.new_credit_balance;
                localStorage.setItem('user', JSON.stringify(user));
                
                alert(data.message || 'Ticket purchased successfully!');
                window.location.href = 'MyTickets.html';
            } else {
                alert(data.message || 'Purchase failed.');
                btn.disabled = false;
                btn.textContent = 'Make payment';
            }
        } catch (error) {
            console.error('Purchase error:', error);
            alert('Error processing purchase. Please try again.');
            btn.disabled = false;
            btn.textContent = 'Make payment';
        }
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkLogin()) return;
        
        loadUserData();
        loadTripData();
        updateSummary();
        
        // Event listeners
        document.querySelector('.btn-apply-coupon').addEventListener('click', validateCoupon);
        document.getElementById('coupon-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') validateCoupon();
        });
        document.getElementById('purchase-btn').addEventListener('click', purchaseTicket);
    });
</script>
</body>
</html>